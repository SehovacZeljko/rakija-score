<!-- LIST VIEW -->
@if (mode() === 'list') {
  <div class="p-4">
    @if (!dataReady()) {
      <app-loading-spinner />
    }

    <!-- Page header -->
    <div class="mb-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold text-text-primary">Uzorci</h1>
      @if (activeFestival() && activeEvent()) {
        <button
          type="button"
          (click)="openCreate()"
          class="flex items-center gap-1.5 rounded-[10px] bg-primary px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-primary-dark active:bg-primary-dark"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          Novi uzorak
        </button>
      }
    </div>

    <!-- No active festival -->
    @if (!activeFestival()) {
      <div class="rounded-xl bg-bg-card p-6 text-center shadow-[0_1px_4px_rgba(0,0,0,0.08)]">
        <p class="text-sm text-text-secondary">Nema aktivnog festivala.</p>
        <p class="mt-1 text-xs text-text-muted">Postavite aktivan festival u sekciji Festivali.</p>
      </div>
    } @else if (!activeEvent()) {
      <app-active-festival-banner />
      <div class="rounded-xl bg-bg-card p-6 text-center shadow-[0_1px_4px_rgba(0,0,0,0.08)]">
        <p class="text-sm text-text-secondary">Nema aktivnog dogadjaja.</p>
        <p class="mt-1 text-xs text-text-muted">Aktivirajte dogadjaj u sekciji Kategorije.</p>
      </div>
    } @else {
      <app-active-festival-banner />
      <!-- Category filter -->
      <div class="mb-4">
        <select
          (change)="onCategoryFilterChange($event)"
          class="w-full rounded-xl border border-border-default bg-bg-card px-3 py-2.5 text-sm text-text-primary focus:border-border-focus focus:outline-none"
        >
          <option value="">Sve kategorije ({{ allSamples().length }})</option>
          @for (cat of categories(); track cat.categoryId) {
            <option [value]="cat.categoryId">{{ cat.name }}</option>
          }
        </select>
      </div>

      <!-- Sample list -->
      @for (sample of filteredSamples(); track sample.sampleId) {
        <button
          type="button"
          (click)="openEdit(sample)"
          class="mb-3 w-full rounded-xl bg-bg-card p-4 text-left shadow-[0_1px_4px_rgba(0,0,0,0.08)] transition-shadow hover:shadow-[0_2px_8px_rgba(0,0,0,0.12)] active:shadow-none"
        >
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0 flex-1">
              <!-- Sample code + order -->
              <div class="flex items-center gap-2">
                <span class="font-semibold text-text-primary">{{ sample.sampleCode }}</span>
                <span class="rounded bg-bg-surface px-1.5 py-0.5 text-[11px] font-medium text-text-muted">
                  #{{ sample.order }}
                </span>
              </div>
              <!-- Producer -->
              <p class="mt-0.5 truncate text-sm text-text-secondary">
                {{ producerMap().get(sample.producerId) ?? '—' }}
              </p>
              <!-- Category + meta -->
              <div class="mt-1 flex flex-wrap gap-x-3 gap-y-0.5">
                @if (!selectedCategoryId()) {
                  <span class="text-xs text-text-muted">
                    {{ categoryMap().get(sample.categoryId) ?? '—' }}
                  </span>
                }
                <span class="text-xs text-text-muted">
                  {{ sample.year }} · {{ sample.alcoholStrength }}%
                </span>
              </div>
            </div>
            <!-- Chevron -->
            <svg
              class="mt-0.5 shrink-0 text-text-muted"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </div>
        </button>
      } @empty {
        <div class="rounded-xl bg-bg-card p-6 text-center shadow-[0_1px_4px_rgba(0,0,0,0.08)]">
          @if (selectedCategoryId()) {
            <p class="text-sm text-text-secondary">Nema uzoraka u ovoj kategoriji.</p>
          } @else {
            <p class="text-sm text-text-secondary">Nema uzoraka. Dodajte prvi uzorak.</p>
          }
        </div>
      }
    }
  </div>
}

<!-- CREATE / EDIT FORM -->
@if (mode() === 'create' || mode() === 'edit') {
  <div class="p-4">
    <!-- Form header -->
    <div class="mb-4 flex items-center gap-3">
      <button
        type="button"
        (click)="cancel()"
        class="flex h-9 w-9 items-center justify-center rounded-lg text-text-secondary transition-colors hover:bg-bg-surface"
        aria-label="Nazad"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="15 18 9 12 15 6" />
        </svg>
      </button>
      <h1 class="text-xl font-semibold text-text-primary">
        {{ mode() === 'create' ? 'Novi uzorak' : 'Uredi uzorak' }}
      </h1>
    </div>

    <!-- Form card -->
    <div [formGroup]="form" class="rounded-xl bg-bg-card p-4 shadow-[0_1px_4px_rgba(0,0,0,0.08)]">
      <!-- Sample code + Order row -->
      <div class="mb-4 flex gap-3">
        <div class="flex-1">
          <label class="mb-1.5 block text-sm font-medium text-text-secondary">
            Šifra uzorka <span class="text-status-error">*</span>
          </label>
          <input
            type="text"
            formControlName="sampleCode"
            placeholder="npr. 1034"
            class="w-full rounded-lg border border-border-default bg-bg-surface px-3 py-2.5 text-sm text-text-primary placeholder:text-text-muted focus:border-border-focus focus:outline-none"
            [class.border-status-error]="form.controls.sampleCode.invalid && form.controls.sampleCode.touched"
          />
        </div>
        <div class="w-24">
          <label class="mb-1.5 block text-sm font-medium text-text-secondary">Redoslijed</label>
          <input
            type="number"
            formControlName="order"
            min="1"
            class="w-full rounded-lg border border-border-default bg-bg-surface px-3 py-2.5 text-sm text-text-primary focus:border-border-focus focus:outline-none"
          />
        </div>
      </div>

      <!-- Producer -->
      <div class="mb-4">
        <label class="mb-1.5 block text-sm font-medium text-text-secondary">
          Producent <span class="text-status-error">*</span>
        </label>
        <select
          formControlName="producerId"
          class="w-full rounded-lg border border-border-default bg-bg-surface px-3 py-2.5 text-sm text-text-primary focus:border-border-focus focus:outline-none"
          [class.border-status-error]="form.controls.producerId.invalid && form.controls.producerId.touched"
        >
          <option value="" disabled>Odaberi producenta</option>
          @for (producer of producers(); track producer.producerId) {
            <option [value]="producer.producerId">{{ producer.name }}</option>
          }
        </select>
      </div>

      <!-- Category -->
      <div class="mb-4">
        <label class="mb-1.5 block text-sm font-medium text-text-secondary">
          Kategorija <span class="text-status-error">*</span>
        </label>
        <select
          formControlName="categoryId"
          class="w-full rounded-lg border border-border-default bg-bg-surface px-3 py-2.5 text-sm text-text-primary focus:border-border-focus focus:outline-none"
          [class.border-status-error]="form.controls.categoryId.invalid && form.controls.categoryId.touched"
        >
          <option value="" disabled>Odaberi kategoriju</option>
          @for (cat of categories(); track cat.categoryId) {
            <option [value]="cat.categoryId">{{ cat.name }}</option>
          }
        </select>
      </div>

      <!-- Year + Alcohol row -->
      <div class="flex gap-3">
        <div class="flex-1">
          <label class="mb-1.5 block text-sm font-medium text-text-secondary">Godina</label>
          <input
            type="number"
            formControlName="year"
            class="w-full rounded-lg border border-border-default bg-bg-surface px-3 py-2.5 text-sm text-text-primary focus:border-border-focus focus:outline-none"
          />
        </div>
        <div class="flex-1">
          <label class="mb-1.5 block text-sm font-medium text-text-secondary">
            Jačina alkohola (%)
          </label>
          <input
            type="number"
            formControlName="alcoholStrength"
            min="0"
            max="100"
            step="0.1"
            class="w-full rounded-lg border border-border-default bg-bg-surface px-3 py-2.5 text-sm text-text-primary focus:border-border-focus focus:outline-none"
          />
        </div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="mt-4 flex gap-3">
      <button
        type="button"
        (click)="save()"
        [disabled]="form.invalid || isSaving()"
        class="flex-1 rounded-[10px] bg-primary py-3 text-sm font-semibold text-white transition-colors hover:bg-primary-dark disabled:cursor-not-allowed disabled:opacity-50"
      >
        {{ isSaving() ? 'Čuvanje...' : 'Sačuvaj' }}
      </button>
      <button
        type="button"
        (click)="cancel()"
        class="rounded-[10px] bg-bg-surface px-6 py-3 text-sm font-semibold text-text-secondary transition-colors hover:bg-border-default"
      >
        Otkaži
      </button>
    </div>
  </div>
}
