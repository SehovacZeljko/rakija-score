<!-- Custom header with back button -->
<header class="fixed left-0 right-0 top-0 z-50 flex h-14 items-center gap-2 bg-primary px-4">
  <button
    type="button"
    (click)="goBack()"
    aria-label="Nazad"
    class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg text-white transition-colors hover:bg-primary-light active:bg-primary-dark"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6" />
    </svg>
  </button>
  <div class="min-w-0 flex-1">
    <p class="truncate text-base font-semibold text-white">
      {{ isLoading() ? '...' : (sample()?.sampleCode ?? '') }}
    </p>
    <p class="text-xs text-white/60">Ocjenjivanje</p>
  </div>
</header>

<main class="min-h-screen bg-bg-app pb-24 pt-14">

  @if (isLoading()) {
    <app-loading-spinner />
  } @else {

    <div class="p-4">

      <!-- Locked banner -->
      @if (isLocked()) {
        <div class="mb-4 flex items-center gap-2 rounded-xl bg-status-locked/10 px-4 py-3">
          <svg class="shrink-0 text-status-locked" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
          </svg>
          <p class="text-sm text-status-locked">Kategorija je zaključana. Ocjena se ne može mijenjati.</p>
        </div>
      }

      <!-- Sample info card -->
      <div class="mb-4 rounded-xl bg-bg-card px-4 py-3 shadow-[0_1px_4px_rgba(0,0,0,0.08)]">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-text-muted">Šifra uzorka</p>
            <p class="text-2xl font-bold text-text-primary">{{ sample()?.sampleCode }}</p>
          </div>
          <div class="text-right">
            <p class="text-xs text-text-muted">Alkohol</p>
            <p class="text-base font-semibold text-text-primary">{{ sample()?.alcoholStrength }}%</p>
          </div>
        </div>
        @if (sample()?.year) {
          <p class="mt-1 text-sm text-text-secondary">Godište: {{ sample()?.year }}</p>
        }
      </div>

      <!-- Scoring criteria -->
      @for (criterion of SCORING_CRITERIA; track criterion.key) {
        <div class="mb-3 rounded-xl bg-bg-card p-4 shadow-[0_1px_4px_rgba(0,0,0,0.08)]">

          <!-- Header row: icon + label + current value -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-text-secondary">
                @switch (criterion.key) {
                  @case ('color') {
                    <!-- Droplet -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                    </svg>
                  }
                  @case ('clarity') {
                    <!-- Eye -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                  }
                  @case ('typicality') {
                    <!-- Star -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                  }
                  @case ('aroma') {
                    <!-- Wind -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M9.59 4.59A2 2 0 1 1 11 8H2"/>
                      <path d="M10.59 19.41A2 2 0 1 0 14 16H2"/>
                      <path d="M15.73 3.73A2.5 2.5 0 1 1 19.5 7H2"/>
                    </svg>
                  }
                  @case ('taste') {
                    <!-- Coffee cup -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                      <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                      <line x1="6" y1="1" x2="6" y2="4"/>
                      <line x1="10" y1="1" x2="10" y2="4"/>
                      <line x1="14" y1="1" x2="14" y2="4"/>
                    </svg>
                  }
                }
              </span>
              <span class="text-sm font-medium text-text-primary">{{ criterion.labelSr }}</span>
            </div>
            <span class="text-base font-bold text-text-primary">
              {{ getCriterionValue(criterion.key).toFixed(2) }}<span class="text-xs font-normal text-text-muted"> / {{ criterion.max.toFixed(2) }}</span>
            </span>
          </div>

          <!-- Slider -->
          <div class="mt-3">
            <input
              type="range"
              class="criterion-slider w-full"
              [style.--progress]="getProgressPercent(criterion) + '%'"
              [min]="criterion.min"
              [max]="criterion.max"
              [step]="SCORE_STEP"
              [value]="getCriterionValue(criterion.key)"
              [disabled]="isLocked()"
              (input)="setPreset(criterion.key, +($any($event.target).value))"
            />
          </div>

          <!-- Max preset -->
          <div class="mt-1.5 flex justify-end">
            <button
              type="button"
              (click)="setPreset(criterion.key, criterion.max)"
              [disabled]="isLocked()"
              class="text-xs text-accent hover:text-accent-hover disabled:cursor-not-allowed disabled:text-text-muted"
            >
              max {{ criterion.max.toFixed(2) }}
            </button>
          </div>

        </div>
      }

      <!-- Total score -->
      <div class="mt-4 flex items-center justify-between rounded-xl bg-primary px-5 py-4">
        <span class="text-base font-semibold text-white">Ukupno</span>
        <span class="text-2xl font-bold text-white">{{ total().toFixed(2) }}</span>
      </div>

      <!-- Comment -->
      <div class="mt-4">
        <label class="mb-1.5 block text-sm font-medium text-text-secondary">Opis (opciono)</label>
        <textarea
          [value]="comment()"
          (input)="onCommentInput($event)"
          [disabled]="isLocked()"
          rows="3"
          placeholder="Bilješka o uzorku..."
          class="w-full rounded-xl border border-border-default bg-bg-card px-3 py-2.5 text-sm text-text-primary placeholder:text-text-muted focus:border-border-focus focus:outline-none disabled:opacity-60"
        ></textarea>
      </div>

    </div>
  }

</main>

<!-- Fixed bottom action -->
@if (!isLoading()) {
  <div class="fixed bottom-0 left-0 right-0 border-t border-border-default bg-white px-4 pb-6 pt-3">
    @if (isLocked()) {
      <div class="flex items-center justify-center gap-2 rounded-xl bg-bg-surface py-3.5">
        <svg class="text-status-locked" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
          <path d="M7 11V7a5 5 0 0 1 10 0v4" />
        </svg>
        <span class="text-sm font-medium text-status-locked">Zaključano</span>
      </div>
    } @else {
      <button
        type="button"
        (click)="saveScore()"
        [disabled]="isSaving()"
        class="w-full rounded-xl bg-primary py-3.5 text-sm font-semibold text-white transition-colors hover:bg-primary-dark disabled:cursor-not-allowed disabled:opacity-50"
      >
        @if (isSaving()) {
          <span class="flex items-center justify-center gap-2">
            <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            </svg>
            Čuvanje...
          </span>
        } @else {
          Sačuvaj
        }
      </button>
    }
  </div>
}
